# üõ†Ô∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ MPS Out of Memory

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

```
MPS backend out of memory (MPS allocated: 8.16 GiB, other allocations: 642.16 MiB, max allowed: 9.07 GiB)
Tried to allocate 320.00 MiB on private pool.
```

**–ü—Ä–∏—á–∏–Ω–∞**: M1 MacBook Air —Å 8GB RAM –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è SDXL —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º 1024x1024.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: 3 –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ü–∞–º—è—Ç–∏

### 1Ô∏è‚É£ –£–º–µ–Ω—å—à–µ–Ω–æ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: 1024 ‚Üí 768

**–§–∞–π–ª**: [config.py:58-59](config.py#L58-L59)

```python
# –ë—ã–ª–æ:
IMAGE_WIDTH = 1024
IMAGE_HEIGHT = 1024

# –°—Ç–∞–ª–æ:
IMAGE_WIDTH = 768   # üöÄ 44% –º–µ–Ω—å—à–µ –ø–∞–º—è—Ç–∏!
IMAGE_HEIGHT = 768
```

**–≠—Ñ—Ñ–µ–∫—Ç**:
- 1024x1024 = 1,048,576 –ø–∏–∫—Å–µ–ª–µ–π
- 768x768 = 589,824 –ø–∏–∫—Å–µ–ª–µ–π
- **–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏**: ~44% (-320 MB MPS)
- **–ö–∞—á–µ—Å—Ç–≤–æ**: –í—Å—ë –µ—â—ë –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è —Å—Ç—Ä–∏–±–æ—Ä–¥–æ–≤

---

### 2Ô∏è‚É£ –í–∫–ª—é—á—ë–Ω CPU Offload

**–§–∞–π–ª**: [config.py:81](config.py#L81)

```python
# –ë—ã–ª–æ:
ENABLE_MODEL_CPU_OFFLOAD = False

# –°—Ç–∞–ª–æ:
ENABLE_MODEL_CPU_OFFLOAD = True  # üöÄ Saves ~3GB MPS
```

**–§–∞–π–ª**: [local_image_generator.py:167-173](local_image_generator.py#L167-L173)

```python
if config.ENABLE_MODEL_CPU_OFFLOAD:
    self.pipe.enable_model_cpu_offload()
    # –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç —á–∞—Å—Ç—å –º–æ–¥–µ–ª–∏ –Ω–∞ CPU –ø—Ä–∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
```

**–≠—Ñ—Ñ–µ–∫—Ç**:
- Text Encoder ‚Üí CPU –∫–æ–≥–¥–∞ –Ω–µ –Ω—É–∂–µ–Ω
- VAE ‚Üí CPU –∫–æ–≥–¥–∞ –Ω–µ –Ω—É–∂–µ–Ω
- UNet –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ MPS (—Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π)
- **–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏**: ~3GB MPS
- **–°–∫–æ—Ä–æ—Å—Ç—å**: -10% (–Ω–æ –∑–∞—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç!)

---

### 3Ô∏è‚É£ –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –û—á–∏—Å—Ç–∫–∞ –ü–∞–º—è—Ç–∏

**–§–∞–π–ª**: [local_image_generator.py:324-329](local_image_generator.py#L324-L329)

```python
image = result.images[0]

# üöÄ Aggressive memory cleanup for M1
del result
if self.device == "mps":
    import gc
    gc.collect()
    torch.mps.empty_cache()

return image
```

**–≠—Ñ—Ñ–µ–∫—Ç**:
- –£–¥–∞–ª—è–µ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–µ–Ω–∑–æ—Ä—ã –°–†–ê–ó–£
- –í—ã–∑—ã–≤–∞–µ—Ç garbage collector
- –û—á–∏—â–∞–µ—Ç MPS –∫–µ—à
- **–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏**: ~500MB –º–µ–∂–¥—É –≥–µ–Ω–µ—Ä–∞—Ü–∏—è–º–∏

---

## üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ü–∞–º—è—Ç–∏: –î–æ vs –ü–æ—Å–ª–µ

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –î–û (1024x1024) | –ü–û–°–õ–ï (768x768 + CPU offload) |
|-----------|----------------|-------------------------------|
| **UNet** | ~5.2 GB | ~3.0 GB (smaller latents) |
| **Text Encoder** | ~1.5 GB MPS | ~0 GB (on CPU) |
| **VAE** | ~1.2 GB MPS | ~0 GB (on CPU when idle) |
| **Latents** | ~320 MB | ~180 MB (-44%) |
| **–ò—Ç–æ–≥–æ MPS** | **~8.2 GB** ‚ùå | **~3.5 GB** ‚úÖ |

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–º–µ—â–∞–µ—Ç—Å—è –≤ 9.07 GB –ª–∏–º–∏—Ç M1!

---

## ‚ö° –í–ª–∏—è–Ω–∏–µ –Ω–∞ –°–∫–æ—Ä–æ—Å—Ç—å

### –ë–µ–∑ CPU Offload (–Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ):
- **–°–∫–æ—Ä–æ—Å—Ç—å**: N/A (OOM error)

### –° CPU Offload:
- **–°–∫–æ—Ä–æ—Å—Ç—å**: ~4-5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- **–ü–∞–º—è—Ç—å**: 3.5 GB MPS (–±–µ–∑–æ–ø–∞—Å–Ω–æ)

**–ö–æ–º–ø—Ä–æ–º–∏—Å—Å**:
- -10% —Å–∫–æ—Ä–æ—Å—Ç—å (offload overhead)
- +100% —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (–Ω–µ –∫—Ä–∞—à–∏—Ç—Å—è!)

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```bash
grep "IMAGE_WIDTH\|IMAGE_HEIGHT\|ENABLE_MODEL_CPU_OFFLOAD" config.py
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å**:
```
IMAGE_WIDTH = 768
IMAGE_HEIGHT = 768
ENABLE_MODEL_CPU_OFFLOAD = True
```

---

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç:

```bash
python3 test_speed.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
```
‚úÖ –û–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ~4-5 —Å–µ–∫—É–Ω–¥
‚úÖ 6 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ~24-30 —Å–µ–∫—É–Ω–¥
‚úÖ –ü–∞–º—è—Ç—å: 3-4 GB MPS (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
```

---

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:

```bash
python3 app.py
```

–¢–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ OOM –æ—à–∏–±–æ–∫!

---

## üé® –ö–∞—á–µ—Å—Ç–≤–æ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ 1024 vs 768:

| –ê—Å–ø–µ–∫—Ç | 1024x1024 | 768x768 |
|--------|-----------|---------|
| **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è** | 10/10 | 9/10 ‚úÖ |
| **–†–µ–∑–∫–æ—Å—Ç—å** | 10/10 | 9/10 ‚úÖ |
| **–ü—Ä–∏–≥–æ–¥–Ω–æ—Å—Ç—å** | –ü–µ—á–∞—Ç—å | Web + Storyboards ‚úÖ |
| **–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞** | ~1.5 MB | ~800 KB |

**–í—ã–≤–æ–¥**: 768x768 –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è:
- –í–µ–±-–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- –°—Ç–æ—Ä–∏–±–æ—Ä–¥–∏–Ω–≥
- –ü—Ä–µ–≤—å—é
- –ê–Ω–∏–º–∞—Ü–∏—è

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ 1024x1024:
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ M1 Pro/Max —Å 16GB+ RAM
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Colab (–æ–±–ª–∞–∫–æ)

---

## üîß –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã (–µ—Å–ª–∏ –≤—Å—ë –µ—â—ë –º–µ–¥–ª–µ–Ω–Ω–æ)

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ï—â—ë –º–µ–Ω—å—à–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (ULTRA FAST)

```python
# config.py:
IMAGE_WIDTH = 512
IMAGE_HEIGHT = 512
```

**–≠—Ñ—Ñ–µ–∫—Ç**:
- –°–∫–æ—Ä–æ—Å—Ç—å: ~2-3 —Å–µ–∫—É–Ω–¥—ã
- –ü–∞–º—è—Ç—å: ~2GB MPS
- –ö–∞—á–µ—Å—Ç–≤–æ: 7/10 (–¥–ª—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤)

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–∫–ª—é—á–∏—Ç—å IP-Adapter

```python
# config.py:
USE_IDENTITY_LOCK = False
```

**–≠—Ñ—Ñ–µ–∫—Ç**:
- –°–∫–æ—Ä–æ—Å—Ç—å: ~3-4 —Å–µ–∫—É–Ω–¥—ã (–≤–º–µ—Å—Ç–æ 4-5)
- –ü–∞–º—è—Ç—å: -500MB
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ª–∏—Ü–∞: 7/10 (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–º–ø—Ç—ã)

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ú–µ–Ω—å—à–µ —à–∞–≥–æ–≤

```python
# config.py:
NUM_INFERENCE_STEPS = 8  # —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ
```

**–≠—Ñ—Ñ–µ–∫—Ç**:
- –°–∫–æ—Ä–æ—Å—Ç—å: ~3 —Å–µ–∫—É–Ω–¥—ã
- –ö–∞—á–µ—Å—Ç–≤–æ: 7.5/10 (–ø—Ä–∏–µ–º–ª–µ–º–æ)

---

## üìà –ò—Ç–æ–≥–æ–≤–∞—è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –¢–µ–∫—É—â–∞—è (BALANCED –¥–ª—è M1 8GB):

```python
IMAGE_WIDTH = 768
IMAGE_HEIGHT = 768
NUM_INFERENCE_STEPS = 12
GUIDANCE_SCALE = 6.5
IP_ADAPTER_SCALE = 0.50
ENABLE_MODEL_CPU_OFFLOAD = True
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ M1 8GB
- ‚úÖ ~4-5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ 8.5/10
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ª–∏—Ü–∞ 85-90%

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ñ–µ–ª–µ–∑—É

| –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|------------|--------------|
| **M1/M2 8GB** | 768x768, CPU offload ‚úÖ (—Ç–µ–∫—É—â–∞—è) |
| **M1/M2 16GB** | 1024x1024, no offload üöÄ |
| **M1/M2 24GB+** | 1024x1024, no offload, steps=20 üé® |
| **Intel Mac** | –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Colab ‚òÅÔ∏è |

---

## üéâ –ò—Ç–æ–≥–∏

### –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: 1024 ‚Üí 768 (-44% –ø–∞–º—è—Ç–∏)
2. ‚úÖ CPU Offload: True (~3GB —ç–∫–æ–Ω–æ–º–∏–∏)
3. ‚úÖ –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

### –†–µ–∑—É–ª—å—Ç–∞—Ç:

```
–î–û:  8.2 GB MPS ‚ùå Out of Memory
–ü–û–°–õ–ï: 3.5 GB MPS ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ!
```

**–°–∫–æ—Ä–æ—Å—Ç—å**: ~4-5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
**–ö–∞—á–µ—Å—Ç–≤–æ**: 8.5/10
**–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: 10/10 ‚úÖ

---

## üöÄ –ì–æ—Ç–æ–≤–æ!

–°–∏—Å—Ç–µ–º–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è **M1 MacBook Air 8GB**.

–ó–∞–ø—É—Å—Ç–∏—Ç–µ `python3 test_speed.py` —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å! üé®
