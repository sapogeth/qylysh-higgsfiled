# Быстрый Старт: Конкурентное Обучение LoRA

## Что делает система?

1. **Анализирует** референсные фотки Алдар Косе (aldar1-5.png)
2. **Генерирует** изображения через:
   - LoRA (ваша локальная модель)
   - Freepik AI
   - DeepAI
   - Google Gemini (опционально)
3. **Сравнивает** качество всех результатов
4. **Говорит LoRA** где улучшаться
5. **Повторяет** пока LoRA не станет лучшей

## Установка за 3 шага

### 1. Установите пакеты

```bash
pip install -r requirements.txt
```

Это установит:
- PyTorch, Diffusers, Transformers (для LoRA)
- CLIP, scikit-image (для анализа)
- Requests (для API провайдеров)

### 2. Ваши API ключи уже в .env

Я уже добавил ваши ключи:

```
DEEPSEEK_API_KEY=sk-2ce976ae9f1a4c8583b707c236fa6139
FREEPIK_API_KEY=FPSX193caafa0683767de2a873582de96305
DEEPAI_API_KEY=bceb509d99484191608a4c615530003a8c9a8e99cd87bc98b500f293bd19be75
GEMINI_API_KEY=AIzaSyBKZihsdTcixwCcYgiGDK696lUsaJ8cEbs
```

### 3. Проверьте систему

```bash
python3 test_competitive_training.py
```

## Запуск обучения

```bash
python3 train_lora_competitive.py
```

## Что происходит?

### Итерация 1

```
═══════════════════════════════════════════════
ИТЕРАЦИЯ 1
═══════════════════════════════════════════════

[ШАГ 1] Анализ референсов...
  ✓ aldar1.png: round face (0.85), narrow eyes (0.78), ...
  ✓ aldar2.png: round face (0.82), narrow eyes (0.80), ...
  ...

[ШАГ 2] Генерация изображений...
  [LORA] Генерация...
    ✓ Сгенерировано за 45.3s
  [FREEPIK] Генерация...
    ✓ Сгенерировано за 8.2s
  [DEEPAI] Генерация...
    ✓ Сгенерировано за 12.5s

[ШАГ 3] Сравнение качества...
  [LORA]
    CLIP similarity: avg=0.742, max=0.801
    Feature matching: 0.715
    Structural similarity (SSIM): 0.623
    📊 Общий Quality Score: 0.712

  [FREEPIK]
    CLIP similarity: avg=0.819, max=0.863
    Feature matching: 0.788
    Structural similarity (SSIM): 0.701
    📊 Общий Quality Score: 0.795

  [DEEPAI]
    CLIP similarity: avg=0.651, max=0.705
    Feature matching: 0.632
    Structural similarity (SSIM): 0.558
    📊 Общий Quality Score: 0.645

[ШАГ 4] Обратная связь для LoRA...
  LoRA Score: 0.712
  Лучший конкурент (freepik): 0.795
  Разница: 0.083

  ⚠️  LoRA нуждается в улучшении!

  Рекомендации:
    • Улучшить семантическое сходство с референсами (отставание: 0.077)
    • Улучшить соответствие ключевым характеристикам (отставание: 0.073)

═══════════════════════════════════════════════
ИТЕРАЦИЯ 1 ЗАВЕРШЕНА
Время: 82.5s
═══════════════════════════════════════════════

🔄 LoRA требует улучшения. Переход к итерации 2...
```

### Итерация 2

Система повторяет процесс, применяя feedback...

### Итерация 3

Если LoRA всё ещё отстаёт, делается финальная итерация.

## Результаты

Всё сохраняется в `lora_training_results/`:

```
lora_training_results/
├── comparisons/
│   ├── lora_20241020_153022.png      ← Изображение от LoRA
│   ├── freepik_20241020_153022.png   ← Изображение от Freepik
│   ├── deepai_20241020_153022.png    ← Изображение от DeepAI
│   └── comparison_report_*.json       ← Детальный отчет
├── feedback/
│   └── feedback_*.json                ← Рекомендации для LoRA
└── training_history.json              ← История всех итераций
```

## Интерпретация Quality Score

- **0.9 - 1.0**: 🏆 Идеально! LoRA - чемпион!
- **0.8 - 0.9**: ✅ Отлично! Почти идеально
- **0.7 - 0.8**: 👍 Хорошо, но можно лучше
- **0.6 - 0.7**: 😐 Средне, нужны улучшения
- **< 0.6**: 😞 Слабо, серьёзные проблемы

## Что делать с результатами?

### Если LoRA лучше всех

```
✓ LoRA показывает лучшие результаты!
```

**Ваши действия**:
- Используйте эту LoRA для генерации!
- Сохраните модель: она в `models/aldar_kose_lora.safetensors`

### Если LoRA отстаёт

```
⚠️  LoRA нуждается в улучшении!
Рекомендации:
  • Улучшить семантическое сходство...
  • Улучшить соответствие ключевым характеристикам...
```

**Ваши действия**:
1. Проверьте `feedback/*.json` - там детали
2. Возможные решения:
   - Увеличить шаги обучения (в `config.py`: `TRAINING_STEPS`)
   - Изменить learning rate (в `config.py`: `LEARNING_RATE`)
   - Добавить больше референсов
   - Улучшить промпты

## Тестирование отдельных компонентов

### 1. Только анализ референсов

```bash
python3 feature_analyzer.py
```

Результат: `models/aldar_feature_analysis.json`

### 2. Только сравнение качества

```bash
python3 image_comparator.py
```

### 3. Только AI провайдеры

```bash
python3 ai_providers.py
```

## FAQ

**Q: Сколько времени занимает?**
A: ~5-10 минут на итерацию (зависит от API провайдеров и вашего M1)

**Q: Нужно ли обучать LoRA отдельно?**
A: Да, сначала запустите `python3 train_aldar_lora.py` или `python3 setup.py`

**Q: Можно ли использовать только один AI провайдер?**
A: Да! Просто удалите ненужные ключи из `.env`

**Q: Что если у меня нет API ключей?**
A: Система всё равно будет работать, но сравнение будет только с локальной LoRA

**Q: Как часто запускать обучение?**
A: После каждого изменения:
- Новых референсов
- Изменения промптов
- Изменения параметров обучения

## Полная документация

Смотрите [COMPETITIVE_TRAINING_README.md](COMPETITIVE_TRAINING_README.md)

---

**Готовы?** Запускайте:

```bash
python3 train_lora_competitive.py
```

**Удачи!** 🚀
